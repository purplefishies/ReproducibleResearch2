---
title: "Investigating the patterns of damage from various natural disasters"
author: "Jimi Damon"
date: "06/21/2015"
output: html_document
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
url:
  lib: ../../librariesNew
  assets: ../../assets
widgets     : [mathjax]            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='./figure/',
                     warning=FALSE, message=FALSE)
```

# Synopsis 

With global scientific consensus corroborating the direct
causal relationship between mankind's consumption of fossil fuels and
global climate change, it is increasingly important that government
agencies be aware of the variety and scale of these events so that
contingency and budgetary plans can be constructed to most effectively
handle these events when they occur.  In addition to planning for
future events, it is important that historical data be preserved for
use in categorizing and comparing new storm events to events measured
during times of lower $CO_2$ concentrations.

In this analysis, we will be investigating ways to assess which weather
related events, as provided by the U.S. National Oceanic and
Atmospheric Administration's (NOAA) storm database between the years
of 1950 and 2011, provide the most harm to both Human life and to the
economy as a whole. The assumptions for this analysis will be built up on
the analysis that Earth's significant meteorological and geological
events of the last 60 years can represent the long term average for
the foreseeable future.


# Setting up the data.

In order to assist with the analysis of a large data set, I have
created two data sets : one represents the full NOAA set of
data, and the other contains a smaller subset of the full set of
data. In order select one data set or the other a "symbolic link" is
setup from the file "stormdata.csv" to point to the data set in
question. 

This approach makes it much easier to regenerate this document for the
full set of data after spending time working and debugging the
analysis while working on the much smaller set of data.  The
metaphorical "switch" can be flipped by just removing the file
"stormdata.csv" and then re-linking it to the large CSV file.

## Libraries used for this analysis
```{r,echo=FALSE,results='asis'}
library(dplyr)
library(ggplot2)
library(lubridate)
```

## Reading in the datasets

```{r,echo=TRUE,results='asis'}
dat <- read.csv("./stormdata.csv")
ddat <- tbl_df( dat )
```


# Data Processing

We need to get our data into a format that avoids redundancy and
over counting. I decided to group the types of weather related disasters
according to the following rules.

* Tornadoes according to the Fujita scale (F-scale) 0,1,2,3,4,5
* Hurricanes that do not involve tornadoes or Hail
* Hail of any type that do not include tornadoes
* Thunderstorm / High Wind related but no Tornadoes, Hurricanes or Hail related
* Cold without Snow and Ice related injuries and deaths
* Heat (without dust)
* Flood 
* Ice and Snow but discounting Cold related effects
* Volcano
* Dust without heat 


The process for creating the filters was performed in an iterative
way so as to ensure that data wasn't counted twice to a given
category. The first data types were relatively easy such as Tornadoes,
but when diving down into a more selective category like HAIl, it was
important to perform appropriate filters that would select out
categories that were already considered such as Tornadoes and
Hurricanes that tend to produce Hail but whose category would be a
super set of the damage chategory being analyzed.

For instance, a typical encounter would be to first filter the events
that matched "wind", and then reduce that set iteratively by
inspecting the unique set of events that matched wind **and then
exclude** events that had been already captured by a previous
grouping.



We calculate each type of event as follows
```{r,echo=TRUE}
length(ddat$F)
```

```{r,echo=TRUE}
capture_stats <- function() {
    setNames(list(~mean(FATALITIES,rm.na=TRUE),
                  ~mean(PROPDMG,rm.na=TRUE),
                  ~mean(PROPDMG,rm.na=TRUE),
                  ~mean(CROPDMG,rm.na=TRUE),
                  ~n()
                  ),
             c("ave_fatalities","ave_injuries","ave_propdmg","ave_cropdmg","nevents")
             )  
}
```


Define the different types of filters for extracting the pertinent information

## Filters

```{r,echo=FALSE}
tornado_filter <- ~!is.na(F)
hurricane_filter <- ~grepl(".*hur[r]?i.*", EVTYPE,perl=T,ignore.case=T )
hail_filter <- ~grepl(".*hail.*", EVTYPE,perl=T,ignore.case=T) & !grepl(".*tornado.*",  EVTYPE,perl=T,ignore.case=T)
wind_tstorm_filter <- ~grepl(".*(wind|thunder|tstm).*", EVTYPE,perl=T,ignore.case=T) &
    !grepl(".*tornado.*",  EVTYPE,perl=T,ignore.case=T) & 
    !grepl(".*hurricane.*",  EVTYPE,perl=T,ignore.case=T) &
    !grepl(".*(cold|chill).*",  EVTYPE,perl=T,ignore.case=T) &
    !grepl(".*(flood).*",  EVTYPE,perl=T,ignore.case=T)

cold_noicesnow_filter <- ~grepl(".*(cold|chill).*", EVTYPE,perl=T,ignore.case=T) &
    !grepl(".*(flood).*",  EVTYPE,perl=T,ignore.case=T) &
    !grepl(".*(snow|ice).*", EVTYPE,perl=T,ignore.case=T)

icesnow_filter <- ~grepl(".*(ice|snow).*", EVTYPE,perl=T,ignore.case=T) & 
  !grepl(".*(flood).*",  EVTYPE,perl=T,ignore.case=T) &
	!grepl(".*(chill|snow).*",EVTYPE,perl=T,ignore.case=T) &
	!grepl(".*(wind).*",EVTYPE,perl=T,ignore.case=T)


head_filter <- ~grepl(".*(heat).*", EVTYPE,perl=T,ignore.case=T)

flood_filter <- ~grepl(".*(flood).*", EVTYPE,perl=T,ignore.case=T) &
    !grepl(".*(thunder|tstm).*",  EVTYPE,perl=T,ignore.case=T) & 
    !grepl(".*(wind).*",  EVTYPE,perl=T,ignore.case=T) & 
    !grepl(".*(snow).*",  EVTYPE,perl=T,ignore.case=T) 

volcano_filter <- ~grepl(".*volc.*", EVTYPE,perl=T,ignore.case=T)

dust_filter <- ~grepl(".*dust.*", EVTYPE,perl=T,ignore.case=T) &
    !grepl(".*(wind).*",EVTYPE,perl=T,ignore.case=T)
```

---
## Example subtables
### Tornadoes

```{r,echo=TRUE}
tornadoes <- ddat %>%
    filter_( .dots=tornado_filter ) %>%
    group_by(F) %>%
    mutate( EVTYPE=ifelse(!is.na(F),paste("TORNADO_F",as.character(F),sep=""),"BLAH"))  %>%
    group_by( EVTYPE ) %>% 
    summarise_( .dots=capture_stats() )
```

### Example of Tornadoe Human and Property Damage
```{r,echo=FALSE}
knitr::kable(tornadoes)
```


### Hurricanes

```{r,echo=TRUE,}
hurricane <- ddat %>%
    filter_( .dots=hurricane_filter ) %>%
    mutate( EVTYPE="HURRICANE") %>%
    group_by(EVTYPE) %>%
    summarise_( .dots=capture_stats() )
```

### Hail only effects

```{r,echo=TRUE}
hail <- ddat %>%
    filter_( .dots=hail_filter ) %>%
    mutate( EVTYPE="HAIL") %>%
    group_by(EVTYPE) %>%
    summarise_( .dots=capture_stats() )
```

### Thunderstorm and Wind

```{r,echo=TRUE}
wind_tstorm <- ddat %>%
    filter_( .dots=wind_tstorm_filter ) %>%
    mutate( EVTYPE="WIND_OR_TSTM") %>%
    group_by(EVTYPE) %>%
    summarise_( .dots=capture_stats() )
```

### Cold Without Snow or Ice

```{r,echo=TRUE}
cold_noicesnow <- ddat %>%
    filter_( .dots=cold_noicesnow_filter ) %>%
    mutate( EVTYPE="COLD") %>%
    group_by(EVTYPE) %>%
    summarise_( .dots=capture_stats() )
```

### Heat 

```{r,echo=TRUE}
heat <- ddat %>%
    filter_( .dots=head_filter ) %>%
    mutate( EVTYPE="HEAT") %>%
    group_by(EVTYPE) %>%
    summarise_( .dots=capture_stats() )

```

### Flood

```{r,echo=TRUE}
flood <- ddat %>%
    filter_( .dots=flood_filter ) %>%
    mutate( EVTYPE="FLOOD") %>%
    group_by(EVTYPE) %>%
    summarise_( .dots=capture_stats() )

```

### Ice and Snow without wind effects

```{r,echo=TRUE}
icesnow <- ddat %>%
    filter_( .dots=icesnow_filter ) %>%
    mutate( EVTYPE="ICE_SNOW") %>%
    group_by(EVTYPE) %>%
    summarise_( .dots=capture_stats() )
```

### Volcano related 

```{r,echo=TRUE}
volcano <- ddat %>%
    filter_( .dots=volcano_filter ) %>% 
    mutate( EVTYPE="VOLCANO") %>%
    group_by(EVTYPE) %>%
    summarise_( .dots=capture_stats() )
```

### Dust related

```{r,echo=TRUE}
dust <- ddat %>%
    filter_( .dots=dust_filter ) %>% 
    mutate( EVTYPE="DUST") %>%
    group_by(EVTYPE) %>%
    summarise_( .dots=capture_stats() )
```

After each factor is isolated, I combine these into a new data table for analysis

```{r,echo=TRUE}
all_data <- Reduce( function(x,y){ merge(x,y,all=T) }, list(tornadoes, hurricane, hail, wind_tstorm, cold_noicesnow, heat, flood, icesnow, volcano, dust ) )
```
```{r,echo=FALSE}
knitr::kable( all_data %>% arrange( desc(ave_fatalities), desc(ave_injuries)))
```

## Analysis of Natural Disasters

For this section we will be investigating how the various disasters
stack up in terms of both injuring Humans as well as causing economic
damage. As these two 

## Will be investigating which types of events are most harmful to human health

Which parameters of the data set indicate deaths / injuries



Which events have the largest economic consequences


# Results

Something goes in here too

# Conclusion 

Something here too
